# Story 1.6: LTH Supply Dynamics (LSD) Integration with ChartInspect

## Status

Ready for Dev

### Dependencies
- Story 1.1 – Data Pipeline Bootstrap
- Story 1.2 – Pipeline Partial Data Handling
- Story 1.3 – Phase Scoring Engine (legacy phase score; being superseded by LSD terminology)
- Story 1.4 – Phase Input Provider Integration (provider abstraction)
- Story 1.5 – Production Scheduling & GitHub Actions Job

## Story

**As** the creator of Timing Terminal  
**I want** the pipeline to compute **Long-Term Holder Supply Dynamics (LSD)** directly from real LTH SOPR and LTH MVRV data fetched via ChartInspect  
**so that** the Netlify/Notion chart reflects the true LTH supply behavior rather than synthetic fixtures, while retaining a compact long-term history for analysis.

This story replaces the synthetic phase-score wiring with a production-capable LSD signal that:
- Pulls LTH metrics and BTC price from ChartInspect APIs via the existing provider abstraction.  
- Computes LSD using the same methodology as the current `market_phase_score.py` script (percentile ranks + multipliers), with Savitzky–Golay smoothed LSD as the canonical series.  
- Retains a Parquet-based history of LSD + BTC price in-repo, and derives `chart-data.json` for the frontend from the most recent window of that history.

## Acceptance Criteria

1. **ChartInspect-backed provider for BTC + LTH metrics**  
   - A `ChartInspectMarketDataProvider` (or equivalent) exists under `pipeline/timing_terminal/providers/` that:  
     - Fetches LTH SOPR and LTH MVRV from ChartInspect endpoints:  
       - `onchain/lth-sopr`  
       - `onchain/lth-mvrv?timeframe=all`  
     - Extracts a normalized BTC price series (`timestamp`, `btc_price`) from the provider responses (preferring MVRV `btc_price`, falling back to SOPR when needed).  
     - Produces aligned series for: `lth_sopr`, `lth_mvrv`, and `btc_price`, sorted by date.  
   - The provider implementation uses configuration (URLs, timeouts, optional headers) and reuses or ports the `fetch_chartinspect_data` behavior (retry, caching) from the existing `market_phase_score.py` script.

2. **LSD scoring logic ported into the scoring module**  
   - The core `market_phase_score` logic is ported into `pipeline/timing_terminal/scoring/` and renamed/treated as **LTH Supply Dynamics (LSD)**:  
     - Uses rolling percentile ranks of LTH MVRV and LTH SOPR over a configurable lookback window (default 2 years).  
     - Combines them with configurable weights (MVRV vs SOPR).  
     - Applies capitulation and euphoria multipliers based on configurable thresholds.  
     - Clips the final LSD values into the range [0, 100].  
   - The scoring API exposes a clear function such as `compute_lsd(lth_sopr, lth_mvrv, config) -> Series[float]`.  
   - Unit tests validate:  
     - Percentile behavior and weighting.  
     - Correct application of multipliers and clipping.  
     - Determinism for the same input.

3. **Canonical LSD smoothing for the product**  
   - The scoring module computes one or more smoothed LSD variants (e.g., SMA, EMA, Savitzky–Golay), but **selects a single canonical series** for the product chart:  
     - For this story, the canonical series is the Savitzky–Golay smoothed LSD (matching the `market_phase_savgol` column in `market_phase_score.py`).  
   - The canonical LSD series is what is stored in history and exposed to the frontend; any additional smoothed variants are optional and for internal analysis only.

4. **Parquet-based LSD history retained in-repo**  
   - A Parquet file `data/lsd_history.parquet` (or similar) is introduced with schema at minimum:  
     - `timestamp` (UTC)  
     - `lsd` (float, canonical LSD)  
     - `btc_price` (float)  
     - Optionally: `zone` (retention/neutral/distribution), `data_quality`.  
   - On each pipeline run in provider mode:  
     - The pipeline loads any existing `lsd_history.parquet`.  
     - Merges new LSD + BTC price points keyed by `timestamp` (upserts by date).  
     - Writes back a sorted Parquet file.  
   - Behavior for first run (no Parquet file yet) is clearly defined (create new file).  
   - The file is kept in-repo and treated as a binary artifact; no complex retention policy is required beyond keeping it reasonably sized for git.

5. **`chart-data.json` driven from LSD history**  
   - `chart-data.json` is generated from the most recent window of `lsd_history.parquet` instead of directly from in-memory fixtures:  
     - `btcPrice[]` comes from `btc_price` values.  
     - `lsd[]` (replacing or superseding `phaseScore[]`) comes from the canonical LSD series.  
     - `lastUpdated` reflects the max `timestamp` from history.  
     - `dataQuality` is computed via the existing `evaluate_data_quality` function based on the underlying `PhasePoint`/history semantics.  
   - The window used for the frontend (e.g., last 850 days or similar) is configurable and documented.  
   - The Netlify/Notion chart can render using `lsd[]` as the right-hand series without further code changes beyond field renaming and legend text.

6. **Configuration & secrets**  
   - ChartInspect base URLs and any required API parameters are configured via `config.py` and environment variables, not hard-coded.  
   - The pipeline can run in:  
     - `fixture` mode (existing behavior) for tests and offline dev.  
     - `provider` mode using the ChartInspect provider.  
   - GitHub Actions workflow remains compatible with both modes and documents how to enable provider mode safely (including where to put secrets if they are introduced later).

7. **Tests & determinism**  
   - Unit tests for the LSD scoring functions live under `pipeline/tests/unit/` and do **not** depend on live HTTP calls.  
   - Integration tests under `pipeline/tests/integration/` use recorded ChartInspect JSON fixtures (or in-memory representations) to simulate provider responses and verify:  
     - Correct construction of LSD + BTC price series.  
     - Correct update of `data/lsd_history.parquet`.  
     - Correct `chart-data.json` schema and values derived from history.  
   - All tests are deterministic and do not require external network access.

## Dev Notes

> This story is about aligning the pipeline with the existing research scripts (`market_phase_score.py`, `market_phase_final.py`) and renaming the core metric to **LTH Supply Dynamics (LSD)** while keeping the architecture’s simple, testable shape.

### Naming & Terminology

- **Product metric name:** Long-Term Holder Supply Dynamics (LSD).  
- **Internal field names (recommendation):**  
  - `lsd` (replacing `phase_score` or `phaseScore`).  
  - `lsd_history.parquet` (replacing `market_phase_score.csv` as canonical store).  
- Existing references to "phase score" in prior stories and docs can remain but should be treated as legacy terminology; new work should use LSD naming.

### Integration with Existing Architecture

- Provider abstraction (`MarketDataProvider`) and config-driven pipeline modes are already in place from Story 1.4; this story reuses that surface and plugs in a real provider.  
- Data quality semantics (`evaluate_data_quality`) from Story 1.2 remain the same and apply to LSD-backed history as well.  
- Scheduling and CI from Story 1.5 continue to run the pipeline daily; this story just changes how the data is sourced and how history is retained.

### Open Questions / To Clarify During Implementation

- Exact ChartInspect URLs and any required authentication details (if ChartInspect requires API keys beyond the current public endpoints).  
- The target window length for the frontend (e.g., last 850 days vs full history) and whether this should be adjusted based on user feedback.  
- Whether to keep `phaseScore` as a deprecated alias in `chart-data.json` for a short transition period or to fully replace it with `lsd` immediately.

## Testing

- **Unit:**  
  - Tests for LSD scoring (ported `market_phase_score`) and any smoothing functions used.  
- **Integration:**  
  - End-to-end pipeline run in provider mode against recorded ChartInspect fixtures that:  
    - Updates `data/lsd_history.parquet`.  
    - Emits a valid `chart-data.json` with `btcPrice[]`, `lsd[]`, `lastUpdated`, and `dataQuality`.  

## Change Log

| Date       | Version | Description                                       | Author |
|------------|---------|---------------------------------------------------|--------|
| 2025-12-11 | v0.1    | Initial draft of Story 1.6 LSD integration       | SM     |
