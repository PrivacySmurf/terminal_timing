# Story 2.4: Basic Access Control & Referer Guard (Edge Function)

## Status

Draft

### Dependencies
- Story 2.1 – Minimal TradingView Chart Page (chart page implemented and verified)
- Story 2.2 – Netlify Build & Static Asset Wiring (Netlify URL stable and documented)
- Story 2.3 – Notion Embedding & Layout Integration (Notion page + embed experience finalized)

## Story

**As** the Timing Terminal operator  
**I want** a minimal access-control layer in front of the Netlify-hosted chart  
**so that** the chart is not trivially public and I have a clean path to future member-level enforcement.

This story introduces a Netlify Edge Function (or equivalent edge middleware) in front of the existing chart page. The edge layer enforces that:

1. Requests originate from approved Notion page(s)/domain(s) via the `Referer` header.  
2. Requests include a static `token` query parameter that matches a configured secret value (e.g., Netlify env var).

At this stage there is still **one shared token** across all members. The goal is to:

- Prevent casual hotlinking or direct public sharing of the chart URL.  
- Establish a simple, well-defined hook (`token` + referer) that can later be upgraded to per-member tokens or more sophisticated auth without changing the overall request pattern.

## Acceptance Criteria

1. **Edge function is wired in front of the chart page**  
   - A Netlify Edge Function (or equivalent in this stack) is configured for the chart route (e.g., `/` or `/chart` depending on current setup).  
   - The function executes for all requests to the chart HTML and any relevant static assets (if needed).  
   - When the function allows a request to pass, the chart renders exactly as before (no behavioral regressions).

2. **Referer allowlist enforced**  
   - The edge function inspects the `Referer` header on each request.  
   - If the referer host is **not** in an explicit allowlist (e.g., Notion domain + optional specific page URL patterns), the function returns a 403 (or a small "access denied" HTML response).  
   - When loading the chart via the approved Notion embed, the referer check passes and the chart loads normally.  
   - Behavior is documented for the case where the referer is missing or stripped by privacy tools (e.g., treat as denied or a configurable fallback).

3. **Static token query parameter enforced**  
   - Chart embed URL in Notion includes a `token` query parameter, for example:  
     - `https://<site-name>.netlify.app/?token=PUBLIC_EMBED_TOKEN`  
   - The edge function reads the `token` query parameter on each request.  
   - Expected token value is not hard-coded in source; it is read from a configuration mechanism (e.g., Netlify env var or config file not checked into git).  
   - If the request `token` does **not** match the configured value (or is missing), the function returns 403 (or the same small "access denied" HTML response).  
   - With the correct token present, and referer allowed, the request is passed through and the chart renders.

4. **Fallback / error behavior is clear and minimal**  
   - The 403 (or access-denied) response is a lightweight HTML page or message that:  
     - Confirms that access is restricted.  
     - Does **not** leak sensitive implementation details (no secrets, no internal paths).  
   - This page is acceptable from a UX standpoint if someone stumbles on the raw chart URL directly.

5. **Future membership path documented**  
   - Dev Notes or a short `docs/` section explain how this referer+token setup can be upgraded later to:  
     - Use signed tokens (e.g., JWTs) instead of static tokens.  
     - Integrate with Stripe/Gumroad/Notion DB for per-member validation.  
   - Document explicitly that Story 2.4 is a **soft gate** (Notion vs non-Notion + static token), not a hard paywall.

## Tasks / Subtasks

- [ ] **Task 1 – Design the access-control scheme** (AC: 1, 2, 3, 5)  
  - [ ] Decide which route(s) the Edge Function should guard (e.g., root `/`, `/index.html`, or a specific chart path).  
  - [ ] Define the referer allowlist (Notion domain + any known page URLs or patterns).  
  - [ ] Decide on the configuration surface: how the function receives the expected `token` value (e.g., Netlify env var `PUBLIC_EMBED_TOKEN`).  
  - [ ] Capture these decisions in Dev Notes or a small doc section so future stories can extend them.

- [ ] **Task 2 – Implement referer-only guard** (AC: 1, 2, 4)  
  - [ ] Create the Netlify Edge Function (or equivalent) and hook it up to the chart route.  
  - [ ] Parse the `Referer` header and normalize it (host extraction, handle trailing slashes, etc.).  
  - [ ] Implement an allowlist check for the approved hosts/URLs.  
  - [ ] On disallowed or missing referer (per design), return a 403 or small HTML "access denied" response.  
  - [ ] Verify that loading via the Notion embed passes the check and renders the chart correctly.

- [ ] **Task 3 – Add static token parameter check** (AC: 1, 3, 4)  
  - [ ] Update the Notion embed URL to include `?token=PUBLIC_EMBED_TOKEN` (or equivalent).  
  - [ ] Update the edge function to read the `token` query parameter.  
  - [ ] Load the expected token value from configuration (e.g., `process.env.PUBLIC_EMBED_TOKEN`).  
  - [ ] If token is missing or does not match, return the same 403/access-denied response used by the referer guard.  
  - [ ] Verify that a correct-token, correct-referer path renders the chart; incorrect token or no token does not.

- [ ] **Task 4 – Testing & validation** (AC: 1, 2, 3, 4)  
  - [ ] Test direct access to the chart URL in the browser (no Notion referer, no token) and confirm it is blocked.  
  - [ ] Test access from the Notion embed with correct token and confirm the chart loads.  
  - [ ] Optionally test a wrong token (e.g., `token=wrong`) and confirm it fails.  
  - [ ] Optionally simulate missing/stripped referer and document chosen behavior.  

- [ ] **Task 5 – Document future membership path** (AC: 5)  
  - [ ] Add a short section to `docs/` (or Dev Notes) describing how this referer+token scheme could be evolved into per-member, signed tokens (JWT) or membership-aware checks.  
  - [ ] Note explicitly that the current configuration is a soft gate and any future story implementing real membership should replace or extend this logic.

## Dev Notes

> This story introduces a minimal edge-based guard only. It does **not** implement per-member auth, billing integration, or a full "login" flow. It is intentionally lightweight and mostly concerned with routing and basic checks.

### Architectural & Product Context

- **Product Experience:** The PRD positions Notion as the initial wrapper for chart + content. This story ensures that the Netlify-hosted chart is not trivially accessible outside that context and that a clear hook exists for future membership enforcement.
- **Security Model:** This is a **soft barrier**, not a full security boundary. A determined attacker could still spoof referers or leak the static token. That is acceptable at this stage; the primary goal is to keep the chart from being casually public.

_See PRD sections related to access control and hosting, and architecture section `docs/architecture.md#frontend-hosting--embedding` for overall context._

### Implementation Guidance

- Keep the edge logic small and focused: parse referer, check allowlist, parse token, compare to env var, and either pass through or return a simple access-denied response.  
- Avoid logging sensitive data (tokens, full URLs) beyond what’s needed for debugging; if you log, consider redacting or truncating.
- Write the edge function in whatever language/runtime the current Netlify setup favors (likely JavaScript/TypeScript for Edge Functions).

## Testing

- **Manual:**  
  - Validate behavior for:  
    - Direct URL visits (no referer, no token) → denied.  
    - Notion embed with correct token → allowed.  
    - Notion embed with wrong token → denied.  
    - Any other origin (e.g., copying the URL into a different site’s iframe) → denied.  
  - Confirm that existing chart functionality (zoom/pan/tooltip) is unaffected when access is granted.

- **Automated (optional, nice-to-have):**  
  - Small integration tests or unit tests for the edge function logic (referer parsing and token validation) if the tooling makes this easy.

## QA Results

- **Gate Decision:** _TBD_  
- **Scope:** Story 2.4 – Basic Access Control & Referer Guard  
- **Summary:** _To be filled in by QA after implementation and validation._

## Change Log

|| Date       | Version | Description                          | Author |
||------------|---------|--------------------------------------|--------|
|| 2025-12-10 | v0.1    | Initial draft of Story 2.4 created   | SM     |
