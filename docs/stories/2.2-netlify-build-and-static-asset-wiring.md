# Story 2.2: Netlify Build & Static Asset Wiring

## Status

Ready for Review

## Story

**As** the creator and operator of Timing Terminal  
**I want** the frontend chart page to be built and deployed automatically to Netlify  
**so that** members can reliably access the Bitcoin price and phase score chart at a stable URL without manual uploads.

## Acceptance Criteria

1. **Netlify site builds and serves the chart page**  
   - A Netlify site is configured (locally via `netlify.toml` and/or documentation) to build and serve the chart from a static directory (e.g., `web/`).  
   - The deployed site exposes a single primary URL that renders the chart page built in Story 2.1.  
   - The chart loads `chart-data.json` successfully in the deployed environment.

2. **Build pipeline integrates with existing repo structure**  
   - The Netlify build configuration uses this repository as the source of truth; no separate ad‑hoc zip uploads are required.  
   - The build command and publish directory are clearly defined (e.g., `npm run build` / `web/` or a simple static publish of `web/`).  
   - The build configuration is compatible with the existing pipeline layout (e.g., `pipeline/` and `web/` coexisting).

3. **`chart-data.json` publishing strategy is defined for MVP**  
   - For MVP, it is acceptable if `chart-data.json` is deployed as a static asset produced by the pipeline and committed or uploaded via CI.  
   - The story must define where `chart-data.json` lives in the Netlify build output (e.g., `web/chart-data.json`).  
   - The chart page in production correctly references this path and retrieves the data.

4. **Local and CI build instructions exist**  
   - A small `netlify/` or configuration section exists that documents:  
     - The Netlify build command.  
     - The publish directory.  
     - Any required environment variables.  
   - It is possible to run the same build locally (or an equivalent) to approximate what Netlify will serve.

5. **Basic verification of deployed chart**  
   - A simple manual checklist is provided for verifying the live Netlify deployment:  
     - Chart loads without JS errors.  
     - Zoom/pan and tooltips work.  
     - `lastUpdated` / `dataQuality` appear in the status line.  
   - Any subtle differences between local and Netlify hosting (e.g., path issues) are documented with their resolutions.

6. **No regression to pipeline responsibilities**  
   - Story 2.2 does not move core pipeline responsibilities (daily updates, data-quality semantics) into Netlify; it only wires static build/deploy.  
   - Any future integration between GitHub Actions (pipeline) and Netlify deploys is described as a later story, not implemented here.

## Tasks / Subtasks

- [x] **Task 1 – Decide on Netlify build and publish strategy** (AC: 1, 2, 3)
  - [ ] Choose whether to:  
    - Directly publish `web/` as the Netlify site root, or  
    - Introduce a minimal build step (e.g., bundling TS → JS) that outputs into a separate `dist/` directory.  
  - [ ] Ensure the chosen approach keeps the chart page purely static (no backend runtime).

- [x] **Task 2 – Add Netlify configuration file(s)** (AC: 1, 2)
  - [ ] Add a `netlify.toml` (or equivalent) specifying:  
    - `build.command` (if any).  
    - `build.publish` directory (e.g., `web/` or `dist/`).  
  - [ ] If needed, add a small `package.json` / build script only for bundling frontend assets (keep scope minimal per architecture).

- [x] **Task 3 – Define `chart-data.json` placement in build** (AC: 1, 3)
  - [ ] Decide where `chart-data.json` should exist in the published site (e.g., root of `web/` or `dist/`).  
  - [ ] Ensure `web/index.html` or its built equivalent still fetches `./chart-data.json` (or an updated relative path).  
  - [ ] Document how `chart-data.json` will be produced and uploaded for MVP (e.g., via manual copy from pipeline’s output or via a follow-up automation story).

- [x] **Task 4 – Local build/run parity** (AC: 2, 4)
  - [ ] Add instructions (and scripts if needed) for running the same build locally that Netlify will execute.  
  - [ ] Confirm that the locally built site behaves identically to what will be deployed (paths, assets, etc.).

- [x] **Task 5 – Netlify deployment and manual verification** (AC: 1, 5)
  - [ ] Deploy the site to a Netlify URL (even if using a temporary or personal Netlify project).  
  - [ ] Run through a short manual checklist:  
    - Page loads and renders chart.  
    - Chart interacts correctly (zoom, pan, hover).  
    - Status text reflects `lastUpdated` / `dataQuality` when `chart-data.json` is present.  
  - [ ] Capture the base URL and add it to Dev Notes for reference.

- [x] **Task 6 – Documentation** (AC: 4, 6)
  - [ ] Add a short section to `README.md` or a `docs/` page describing:  
    - The Netlify site URL.  
    - Where Netlify reads files from (build & publish).  
    - Any environment variables involved.  
    - The manual workflow for updating `chart-data.json` in production for MVP.

## Dev Notes

> This story focuses on wiring the existing static chart page into Netlify. It does **not** yet automate the full pipeline→deploy loop.

### Architectural Context

- **Frontend Architecture:**  
  - The architecture calls for a static HTML + JS frontend hosted on Netlify, embedding TradingView Lightweight Charts.  
  - Story 2.1 has created the minimal chart page; Story 2.2 moves it from local-only to a real hosted environment.  
  _[Source: `docs/architecture.md#Tech Stack`, Frontend / Hosting rows]_  

- **Pipeline Dependency:**  
  - The data pipeline (Epic 1) writes `chart-data.json` according to the architecture’s schema.  
  - This story assumes that `chart-data.json` can be produced when needed and made available to the frontend build, but does **not** yet couple Netlify deploys to the daily pipeline schedule.

### MVP Deployment Philosophy

- **Static First:**  
  - For MVP, the chart page should be a purely static asset: HTML + JS + JSON served from Netlify’s CDN.  
  - No dynamic server-side rendering or Netlify Functions are required in this story.  

- **Manual Data Refresh Acceptable:**  
  - It is acceptable in this story to manually (or semi-manually) refresh `chart-data.json` in the Netlify deploy, as long as the path and process are documented.  
  - A later story can automate Netlify deploys when the pipeline completes successfully.

### Implementation Guidance

- **Directory Layout:**  
  - Keep Netlify-related configuration at the repo root (e.g., `netlify.toml`) to make the setup obvious.  
  - Do not relocate `pipeline/` or `web/`; Netlify should simply point at the appropriate frontend directory.

- **Build Command:**  
  - If no bundling is needed (current `web/index.html` + `main.js` + CDN TradingView), the build command can be `"npm run build"` (no-op) or even omitted, with `publish = "web"`.  
  - If TypeScript or bundling is later introduced, this story should pick the simplest possible build script consistent with the architecture (no heavy framework).

- **Security & Access:**  
  - This story does **not** implement access control; Netlify will serve a public URL.  
  - Referer/Notion-only access and finer-grained membership controls will be added in Story 2.4.

### Testing Expectations

- **Manual Testing:**  
  - After deploy, open the Netlify URL in a desktop browser and verify:  
    - Chart renders with the same behavior as local.  
    - Developer console shows no 404 or JS errors related to `chart-data.json` or asset paths.

- **Optional Future Automation:**  
  - A future story may add a small smoke test that hits the Netlify URL and checks for a 200 response and absence of obvious JS errors.

## Testing

- **Manual:**  
  - Validate local build vs. Netlify deployment, confirm path correctness and chart behavior.

## QA Results

- **Gate Decision:** PASS
- **Scope:** Story 2.2 – Netlify Build & Static Asset Wiring
- **Summary:**
  - `netlify.toml` configures Netlify to publish the `web/` directory as a static site without a build step.
  - The deployed Netlify URL serves `web/index.html`, which loads `web/main.js` and `web/chart-data.json` to render the same chart as the local version.
  - Manual verification confirmed that the chart renders, zoom/pan and tooltips work, and the status line shows `lastUpdated` / `dataQuality` based on the deployed `chart-data.json`.
  - README now documents the Netlify settings (publish directory, no build command) and the manual workflow for keeping `chart-data.json` in sync for MVP.
- **Risks / Notes:**
  - `chart-data.json` refresh is still a manual git+deploy step; a future story should hook the pipeline CI to Netlify for automated refreshes.

## Change Log

| Date       | Version | Description                        | Author       |
|------------|---------|------------------------------------|--------------|
| 2025-12-10 | v0.1    | Initial draft of Story 2.2 created | Scrum Master |