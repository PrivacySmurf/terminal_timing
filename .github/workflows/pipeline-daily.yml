name: Pipeline Daily

on:
  schedule:
    # Daily at 06:00 UTC â€“ adjust as needed
    - cron: '0 6 * * *'
  workflow_dispatch:

jobs:
  test-and-run-pipeline:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    env:
      # Default to fixture mode; can be overridden via a GitHub Actions variable
      # Set repository/organization variable `TT_PIPELINE_MODE=provider` to
      # exercise the provider-backed path.
      TT_PIPELINE_MODE: ${{ vars.TT_PIPELINE_MODE || 'fixture' }}

      # Set `TT_CHARTINSPECT_MODE=live` to fetch real data from ChartInspect API.
      # When omitted or set to 'fixture', uses in-memory test data.
      TT_CHARTINSPECT_MODE: ${{ vars.TT_CHARTINSPECT_MODE || 'fixture' }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install uv
        run: |
          curl -LsSf https://astral.sh/uv/install.sh | sh
          echo "${HOME}/.local/bin" >> "$GITHUB_PATH"

      - name: Run pipeline tests (unit + integration)
        run: |
          chmod +x ./run-tests
          ./run-tests

      - name: Run pipeline CLI
        working-directory: ./pipeline
        env:
          TT_PIPELINE_MODE: ${{ env.TT_PIPELINE_MODE }}
          TT_CHARTINSPECT_MODE: ${{ env.TT_CHARTINSPECT_MODE }}
        run: |
          echo "TT_PIPELINE_MODE=$TT_PIPELINE_MODE"
          echo "TT_CHARTINSPECT_MODE=$TT_CHARTINSPECT_MODE"
          uv run timing-terminal-pipeline

      - name: Copy output to web directory
        run: |
          cp pipeline/pipeline/out/chart-data.json web/chart-data.json
          echo "Copied chart-data.json to web/"

      - name: Commit and push updated chart data
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add web/chart-data.json
          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            git commit -m "data: update chart-data.json [skip ci]"
            git push
          fi

      - name: Show pipeline summary
        if: always()
        run: |
          if [ -f web/chart-data.json ]; then
            echo "chart-data.json updated in web/"
            echo "Summary (first 40 lines):"
            head -n 40 web/chart-data.json || true
          else
            echo "chart-data.json was not generated" >&2
            exit 1
          fi

      - name: Notify Discord (optional)
        if: always() && env.DISCORD_WEBHOOK_URL != ''
        env:
          DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL || '' }}
        run: |
          STATUS="${{ job.status }}"
          MESSAGE="Timing Terminal pipeline run: ${STATUS} (dataQuality not parsed here; see logs/chart-data.json)"
          curl -X POST -H 'Content-Type: application/json' \
            -d "{\"content\": \"${MESSAGE}\"}" "${DISCORD_WEBHOOK_URL}" || echo "Discord notify failed (non-blocking)"
